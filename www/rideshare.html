<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rideshare - Available Rides</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col">
                <div id="app">
                    <h1 class="my-4">Rideshare - Available Rides</h1>
                    
                    <div class="mb-3">
                        <button @click="loadRides" :disabled="loading" class="btn btn-primary">
                            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                            {{ loading ? 'Loading...' : 'Update' }}
                        </button>
                        <span class="ms-3">{{ statusMessage }}</span>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Contact</th>
                                    <th>Start Time</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Seats</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="loading && rides.length === 0">
                                    <td colspan="6" class="text-center">Loading rides...</td>
                                </tr>
                                <tr v-else-if="error">
                                    <td colspan="6" class="text-center text-danger">{{ error }}</td>
                                </tr>
                                <tr v-else-if="rides.length === 0">
                                    <td colspan="6" class="text-center">No rides available yet</td>
                                </tr>
                                <tr v-else v-for="ride in rides" :key="ride.id">
                                    <td>
                                        <strong>{{ ride.contact.name }}</strong><br>
                                        <small>{{ ride.contact.email }}</small><br>
                                        <small>{{ ride.contact.phone }}</small>
                                    </td>
                                    <td>{{ formatDateTime(ride.startDateTime) }}</td>
                                    <td>{{ ride.startTown }}</td>
                                    <td>{{ ride.destinationTown }}</td>
                                    <td>
                                        <span :class="['badge', getSeatsBadgeClass(ride.availableSeats)]">
                                            {{ ride.availableSeats === 0 ? 'Full' : ride.availableSeats }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-2">
                                        <button @click="bookSeat(ride.id)" class="btn btn-sm btn-outline-primary" :disabled="bookingId === ride.id || ride.availableSeats === 0">
                                            <span v-if="bookingId === ride.id" class="spinner-border spinner-border-sm me-1"></span>
                                            Book a seat
                                        </button>
                                        <button @click="deleteRide(ride.id)" class="btn btn-sm btn-outline-danger" :disabled="deletingId === ride.id">
                                            <span v-if="deletingId === ride.id" class="spinner-border spinner-border-sm me-1"></span>
                                            Remove
                                        </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h2 class="mt-5 mb-3">Add New Ride</h2>
                    <form @submit.prevent="addRide">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="contactName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="contactName" v-model="newRide.contact.name" required>
                            </div>
                            <div class="col-md-4">
                                <label for="contactEmail" class="form-label">Email (optional)</label>
                                <input type="email" class="form-control" id="contactEmail" v-model="newRide.contact.email" placeholder="name@example.com">
                            </div>
                            <div class="col-md-4">
                                <label for="contactPhone" class="form-label">Phone (optional)</label>
                                <input type="tel" class="form-control" id="contactPhone" v-model="newRide.contact.phone" placeholder="+49 123 456789">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="startDateTime" class="form-label">Start Date & Time</label>
                                <input type="datetime-local" class="form-control" id="startDateTime" v-model="newRide.startDateTime" required>
                            </div>
                            <div class="col-md-6">
                                <label for="availableSeats" class="form-label">Available Seats</label>
                                <input type="number" class="form-control" id="availableSeats" v-model.number="newRide.availableSeats" min="0" max="10" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label" for="startTown">Start Town</label>
                                <input type="text" id="startTown" class="form-control" v-model="newRide.startTown" required placeholder="e.g. Berlin">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="destinationTown">Destination Town</label>
                                <input type="text" id="destinationTown" class="form-control" v-model="newRide.destinationTown" required placeholder="e.g. Hamburg">
                            </div>
                        </div>

                        <div v-if="formError" class="alert alert-danger">{{ formError }}</div>
                        <div v-if="formSuccess" class="alert alert-success">{{ formSuccess }}</div>

                        <button type="submit" class="btn btn-success" :disabled="submitting">
                            <span v-if="submitting" class="spinner-border spinner-border-sm me-2"></span>
                            {{ submitting ? 'Adding...' : 'Add Ride' }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    rides: [],
                    loading: false,
                    error: null,
                    statusMessage: '',
                    apiUrl: 'http://localhost:8081/v1/list',
                    apiCreateUrl: 'http://localhost:8081/v1/ride',
                    submitting: false,
                    formError: null,
                    formSuccess: null,
                    deletingId: null,
                    bookingId: null,
                    newRide: {
                        contact: {
                            name: '',
                            email: '',
                            phone: ''
                        },
                        startDateTime: '',
                        startTown: '',
                        destinationTown: '',
                        availableSeats: 1
                    }
                };
            },
            methods: {
                async loadRides() {
                    this.loading = true;
                    this.error = null;
                    this.statusMessage = 'Loading...';

                    try {
                        const response = await fetch(this.apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        this.rides = await response.json();
                        
                        const count = this.rides.length;
                        this.statusMessage = count === 0 ? 'No rides found' : `Loaded ${count} ride${count !== 1 ? 's' : ''}`;
                    } catch (err) {
                        console.error('Error loading rides:', err);
                        this.error = 'Error loading rides. Please try again.';
                        this.statusMessage = 'Error loading rides';
                    } finally {
                        this.loading = false;
                    }
                },
                formatDateTime(isoString) {
                    const date = new Date(isoString);
                    return date.toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                getSeatsBadgeClass(seats) {
                    if (seats === 0) return 'bg-danger';
                    if (seats <= 2) return 'bg-warning';
                    return 'bg-success';
                },
                async addRide() {
                    this.submitting = true;
                    this.formError = null;
                    this.formSuccess = null;

                    try {
                        // Convert datetime-local to ISO 8601
                        const rideData = {
                            ...this.newRide,
                            startDateTime: new Date(this.newRide.startDateTime).toISOString()
                        };
                        // Normalize optional fields: empty string -> null
                        if (!rideData.contact.email) rideData.contact.email = null;
                        if (!rideData.contact.phone) rideData.contact.phone = null;

                        const response = await fetch(this.apiCreateUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(rideData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.details ? errorData.details.join(', ') : 'Failed to create ride');
                        }

                        const result = await response.json();
                        this.formSuccess = 'Ride added successfully!';
                        
                        // Reset form
                        this.newRide = {
                            contact: {
                                name: '',
                                email: '',
                                phone: ''
                            },
                            startDateTime: '',
                            startTown: '',
                            destinationTown: '',
                            availableSeats: 1
                        };

                        // Reload rides to show the new one
                        await this.loadRides();

                        // Clear success message after 3 seconds
                        setTimeout(() => {
                            this.formSuccess = null;
                        }, 3000);
                    } catch (err) {
                        console.error('Error adding ride:', err);
                        this.formError = err.message || 'Error adding ride. Please try again.';
                    } finally {
                        this.submitting = false;
                    }
                },
                async deleteRide(id) {
                    this.deletingId = id;
                    try {
                        const response = await fetch(`http://localhost:8081/v1/ride/${id}`, { method: 'DELETE' });
                        if (!response.ok) {
                            throw new Error('Failed to delete ride');
                        }
                        // Remove locally without full reload for snappier UX
                        this.rides = this.rides.filter(r => r.id !== id);
                        this.statusMessage = 'Ride removed';
                    } catch (err) {
                        console.error('Delete error:', err);
                        this.statusMessage = 'Error removing ride';
                    } finally {
                        this.deletingId = null;
                    }
                },
                async bookSeat(id) {
                    this.bookingId = id;
                    try {
                        const ride = this.rides.find(r => r.id === id);
                        if (!ride) throw new Error('Ride not found');
                        if (ride.availableSeats === 0) return; // nothing to book

                        // PUT expects the ride data (without id is fine, server overrides). Keep structure.
                        const body = { 
                            contact: ride.contact,
                            startDateTime: ride.startDateTime,
                            startTown: ride.startTown,
                            destinationTown: ride.destinationTown,
                            availableSeats: ride.availableSeats - 1
                        };
                        const response = await fetch(`http://localhost:8081/v1/ride/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        if (!response.ok) throw new Error('Failed to book seat');
                        // Update local state
                        ride.availableSeats = ride.availableSeats - 1;
                        this.statusMessage = 'Seat booked';
                    } catch (err) {
                        console.error('Book seat error:', err);
                        this.statusMessage = 'Error booking seat';
                    } finally {
                        this.bookingId = null;
                    }
                }
            },
            mounted() {
                this.loadRides();
            }
        }).mount('#app');
    </script>
</body>
</html>
